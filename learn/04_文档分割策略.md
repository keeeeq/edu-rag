# çŸ¥è¯†ç‚¹ 4: æ–‡æ¡£åˆ†å‰²ç­–ç•¥

> ğŸ“ **æ ¸å¿ƒæ–‡ä»¶**: `rag_qa/core/document_processor.py` + `rag_qa/edu_text_spliter/`  
> â±ï¸ **å­¦ä¹ æ—¶é—´**: çº¦ 30-40 åˆ†é’Ÿ  
> ğŸ¯ **é‡è¦æ€§**: â­â­â­â­ (ç›´æ¥å½±å“æ£€ç´¢è´¨é‡)

---

## ğŸ¤” æ ¸å¿ƒé—®é¢˜ï¼šä¸ºä»€ä¹ˆéœ€è¦æ–‡æ¡£åˆ†å‰²ï¼Ÿ

### åŸå§‹æ–‡æ¡£ vs åˆ†å‰²åæ–‡æ¡£

```
åŸå§‹æ–‡æ¡£ï¼ˆ5000å­—ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AIè¯¾ç¨‹ä»‹ç»                             â”‚
â”‚                                        â”‚
â”‚ ç¬¬ä¸€éƒ¨åˆ†ï¼šè¯¾ç¨‹æ¦‚è¿°ï¼ˆ1000å­—ï¼‰           â”‚
â”‚ ç¬¬äºŒéƒ¨åˆ†ï¼šè¯¾ç¨‹å¤§çº²ï¼ˆ2000å­—ï¼‰           â”‚
â”‚ ç¬¬ä¸‰éƒ¨åˆ†ï¼šå­¦è´¹è¯´æ˜ï¼ˆ500å­—ï¼‰            â”‚  â† ç”¨æˆ·æƒ³è¦çš„ä¿¡æ¯
â”‚ ç¬¬å››éƒ¨åˆ†ï¼šå¸ˆèµ„ä»‹ç»ï¼ˆ1000å­—ï¼‰           â”‚
â”‚ ç¬¬äº”éƒ¨åˆ†ï¼šå°±ä¸šä¿éšœï¼ˆ500å­—ï¼‰            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼š
âŒ å‘é‡åŒ–æ•´ä¸ª5000å­— â†’ ä¿¡æ¯å¯†åº¦ä½ï¼Œæ£€ç´¢ä¸ç²¾ç¡®
âŒ LLM Context å¤ªé•¿ â†’ å¹²æ‰°ä¿¡æ¯å¤šï¼Œå®¹æ˜“"èµ°ç¥"
âŒ æ— æ³•ç²¾ç¡®å®šä½ â†’ ç”¨æˆ·é—®å­¦è´¹ï¼Œå´è¿”å›æ•´ä¸ªæ–‡æ¡£
```

**è§£å†³æ–¹æ¡ˆï¼šæ–‡æ¡£åˆ†å‰²**

```
åˆ†å‰²åï¼ˆæ¯å—300-1200å­—ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Chunk 1     â”‚  â”‚ Chunk 2     â”‚  â”‚ Chunk 3     â”‚
â”‚ è¯¾ç¨‹æ¦‚è¿°    â”‚  â”‚ è¯¾ç¨‹å¤§çº²    â”‚  â”‚ å­¦è´¹è¯´æ˜    â”‚  â† ç²¾ç¡®æ£€ç´¢
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿ï¼š
âœ… æ¯ä¸ªå—ä¿¡æ¯å•ä¸€ â†’ å‘é‡æ›´ç²¾ç¡®
âœ… æ£€ç´¢æ›´å‡†ç¡® â†’ ç”¨æˆ·é—®å­¦è´¹ï¼Œåªè¿”å›Chunk 3
âœ… ä¸Šä¸‹æ–‡ç®€æ´ â†’ LLM ç”Ÿæˆç­”æ¡ˆæ›´å‡†ç¡®
```

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šçˆ¶å­æ–‡æ¡£åˆ‡åˆ†çš„æ ¸å¿ƒè®¾è®¡ â­â­â­

### ğŸ¯ è®¾è®¡æ€æƒ³ï¼šåˆ†å±‚åˆ‡åˆ†

```
åŸå§‹æ–‡æ¡£ï¼ˆ10000å­—ï¼‰
         â†“
   ç¬¬1å±‚åˆ‡åˆ†ï¼ˆçˆ¶æ–‡æ¡£ï¼‰
   chunk_size = 1200å­—
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çˆ¶æ–‡æ¡£1 (1200å­—)                â”‚
â”‚ â”œâ”€â”€ å­æ–‡æ¡£1.1 (300å­—) â† ç”¨äºæ£€ç´¢ â”‚
â”‚ â”œâ”€â”€ å­æ–‡æ¡£1.2 (300å­—)            â”‚
â”‚ â”œâ”€â”€ å­æ–‡æ¡£1.3 (300å­—)            â”‚
â”‚ â””â”€â”€ å­æ–‡æ¡£1.4 (300å­—)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çˆ¶æ–‡æ¡£2 (1200å­—)                â”‚
â”‚ â”œâ”€â”€ å­æ–‡æ¡£2.1 (300å­—)            â”‚
â”‚ â”œâ”€â”€ å­æ–‡æ¡£2.2 (300å­—)            â”‚
â”‚ ...                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ£€ç´¢æµç¨‹ï¼š
1. ç”¨å­æ–‡æ¡£æ£€ç´¢ï¼ˆ300å­—ï¼Œç²¾ç¡®ï¼‰
2. è¿”å›å¯¹åº”çš„çˆ¶æ–‡æ¡£ï¼ˆ1200å­—ï¼Œå®Œæ•´ä¸Šä¸‹æ–‡ï¼‰
```

### ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦çˆ¶å­æ–‡æ¡£ï¼Ÿ

**å•ä¸€æ–‡æ¡£å¤§å°çš„å›°å¢ƒ**ï¼š

| æ–‡æ¡£å¤§å° | æ£€ç´¢ç²¾åº¦ | ä¸Šä¸‹æ–‡å®Œæ•´æ€§ | ç»“è®º |
|---------|---------|-------------|------|
| å°ï¼ˆ300å­—ï¼‰| âœ… é«˜ | âŒ ä¸å®Œæ•´ | æ£€ç´¢å‡†ä½†ç­”æ¡ˆä¸å…¨ |
| å¤§ï¼ˆ1200å­—ï¼‰| âŒ ä½ | âœ… å®Œæ•´ | ä¸Šä¸‹æ–‡å¥½ä½†æ£€ç´¢ä¸å‡† |
| **çˆ¶å­ç»“æ„** | âœ… é«˜ | âœ… å®Œæ•´ | **ä¸¤å…¨å…¶ç¾** â­ |

**æ ¸å¿ƒæ€æƒ³**ï¼š
```
å­æ–‡æ¡£ = æ£€ç´¢çš„ç²¾ç¡®åº¦
çˆ¶æ–‡æ¡£ = ç”Ÿæˆçš„å®Œæ•´æ€§

æ£€ç´¢æ—¶ç”¨å­æ–‡æ¡£ï¼ˆå°è€Œç²¾å‡†ï¼‰
ç”Ÿæˆæ—¶ç”¨çˆ¶æ–‡æ¡£ï¼ˆå¤§è€Œå®Œæ•´ï¼‰
```

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šæ–‡æ¡£åˆ†å‰²ä»£ç è¯¦è§£

### ğŸ”§ æ ¸å¿ƒå‡½æ•°ï¼š`process_documents`

**ä»£ç ä½ç½®**: `document_processor.py` ç¬¬ 106-171 è¡Œ

```python
def process_documents(directory_path, 
                     parent_chunk_size=1200,  # çˆ¶æ–‡æ¡£å¤§å°
                     child_chunk_size=300,    # å­æ–‡æ¡£å¤§å°
                     chunk_overlap=50):       # é‡å éƒ¨åˆ†
    
    # æ­¥éª¤1: åŠ è½½åŸå§‹æ–‡æ¡£
    documents = load_documents_from_directory(directory_path)
    
    # æ­¥éª¤2: åˆå§‹åŒ–åˆ†å‰²å™¨
    parent_splitter = ChineseRecursiveTextSplitter(
        chunk_size=parent_chunk_size, 
        chunk_overlap=chunk_overlap
    )
    child_splitter = ChineseRecursiveTextSplitter(
        chunk_size=child_chunk_size, 
        chunk_overlap=chunk_overlap
    )
    
    # æ­¥éª¤3: åˆ†å±‚åˆ‡åˆ†
    child_chunks = []
    for i, doc in enumerate(documents):
        # 3.1 å…ˆåˆ‡æˆçˆ¶æ–‡æ¡£
        parent_docs = parent_splitter.split_documents([doc])
        
        for j, parent_doc in enumerate(parent_docs):
            parent_id = f"doc_{i}_parent_{j}"
            
            # 3.2 å†åˆ‡æˆå­æ–‡æ¡£
            sub_chunks = child_splitter.split_documents([parent_doc])
            
            # 3.3 ä¸ºå­æ–‡æ¡£æ·»åŠ çˆ¶æ–‡æ¡£ä¿¡æ¯
            for k, sub_chunk in enumerate(sub_chunks):
                sub_chunk.metadata["parent_id"] = parent_id
                sub_chunk.metadata["parent_content"] = parent_doc.page_content  # â† å…³é”®
                sub_chunk.metadata["id"] = f"{parent_id}_child_{k}"
                child_chunks.append(sub_chunk)
    
    return child_chunks  # è¿”å›å­æ–‡æ¡£ï¼ˆå¸¦çˆ¶æ–‡æ¡£ä¿¡æ¯ï¼‰
```

### ğŸ’¡ å…³é”®è®¾è®¡ç‚¹

#### 1. åˆ†å±‚IDç®¡ç†

```python
åŸå§‹æ–‡æ¡£ [0]
     â†“
çˆ¶æ–‡æ¡£: doc_0_parent_0, doc_0_parent_1, doc_0_parent_2
     â†“
å­æ–‡æ¡£: 
  - doc_0_parent_0_child_0
  - doc_0_parent_0_child_1
  - doc_0_parent_0_child_2
  - doc_0_parent_1_child_0
  ...
```

**ä¼˜åŠ¿**ï¼š
- âœ… IDå”¯ä¸€ä¸”å¯è¿½æº¯
- âœ… å¯ä»¥å¿«é€Ÿå®šä½åŸå§‹æ–‡æ¡£
- âœ… ä¾¿äºè°ƒè¯•å’Œé—®é¢˜æ’æŸ¥

#### 2. çˆ¶æ–‡æ¡£å†…å®¹åµŒå…¥

**ä»£ç ä½ç½®**: ç¬¬ 161 è¡Œ

```python
sub_chunk.metadata["parent_content"] = parent_doc.page_content
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**

```python
# æ£€ç´¢æ—¶
query = "AIè¯¾ç¨‹çš„å­¦è´¹æ˜¯å¤šå°‘ï¼Ÿ"
â†’ æ£€ç´¢åˆ°å­æ–‡æ¡£: "AIè¯¾ç¨‹å­¦è´¹ä¸º19800å…ƒ..."

# ç”Ÿæˆæ—¶
sub_chunk.metadata["parent_content"]
â†’ è¿”å›çˆ¶æ–‡æ¡£: "AIè¯¾ç¨‹ä»‹ç»...å­¦è´¹ä¸º19800å…ƒ...åŒ…å«å®æˆ˜é¡¹ç›®..."
```

**ä¼˜åŠ¿**ï¼š
- âœ… å­æ–‡æ¡£å¸¦ç€çˆ¶æ–‡æ¡£ä¿¡æ¯
- âœ… æ£€ç´¢åç›´æ¥æ‹¿åˆ°å®Œæ•´ä¸Šä¸‹æ–‡
- âœ… æ— éœ€äºŒæ¬¡æŸ¥è¯¢æ•°æ®åº“

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šä¸­æ–‡é€’å½’åˆ†å‰²å™¨ â­â­

### ğŸ¨ `ChineseRecursiveTextSplitter` åŸç†

**ä»£ç ä½ç½®**: `edu_chinese_recursive_text_splitter.py`

#### æ ¸å¿ƒæ€æƒ³ï¼šé€’å½’ + ä¼˜å…ˆçº§åˆ†å‰²

```python
class ChineseRecursiveTextSplitter(RecursiveCharacterTextSplitter):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        # åˆ†éš”ç¬¦ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰
        self._separators = [
            "\\n\\n",      # ä¼˜å…ˆçº§1: åŒæ¢è¡Œï¼ˆæ®µè½ï¼‰
            "\\n",        # ä¼˜å…ˆçº§2: å•æ¢è¡Œï¼ˆè¡Œï¼‰
            "ã€‚|ï¼|ï¼Ÿ",   # ä¼˜å…ˆçº§3: ä¸­æ–‡å¥å·ã€æ„Ÿå¹å·ã€é—®å·
            "\\.\\s|\\!\\s|\\?\\s",  # è‹±æ–‡æ ‡ç‚¹
            "ï¼›|;\\s",    # åˆ†å·
            "ï¼Œ|,\\s"     # é€—å·
        ]
```

### ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ä¼˜å…ˆçº§ï¼Ÿ

**ä¾‹å­**ï¼š

```
åŸå§‹æ–‡æœ¬ï¼ˆ600å­—ï¼Œè¶…è¿‡chunk_size=300ï¼‰ï¼š
"
ç¬¬ä¸€æ®µï¼šAIè¯¾ç¨‹ä»‹ç»ã€‚æœ¬è¯¾ç¨‹æ¶µç›–æœºå™¨å­¦ä¹ ã€æ·±åº¦å­¦ä¹ ç­‰å†…å®¹ã€‚

ç¬¬äºŒæ®µï¼šè¯¾ç¨‹å­¦è´¹ä¸º19800å…ƒï¼ŒåŒ…å«çº¿ä¸Šè¯¾ç¨‹å’Œå®æˆ˜é¡¹ç›®ã€‚

ç¬¬ä¸‰æ®µï¼šå­¦ä¹ å‘¨æœŸä¸º6ä¸ªæœˆã€‚
"

é€’å½’åˆ‡åˆ†è¿‡ç¨‹ï¼š
1. å°è¯•ç”¨"\n\n"åˆ†å‰²ï¼ˆæ®µè½ï¼‰ â† ä¼˜å…ˆçº§æœ€é«˜
   â†’ åˆ‡æˆ3æ®µï¼Œæ¯æ®µ<300å­— âœ…
   
2. å¦‚æœæ®µè½è¿˜æ˜¯å¤ªå¤§ï¼Œå†ç”¨"\n"åˆ†å‰²ï¼ˆè¡Œï¼‰
3. å¦‚æœè¡Œè¿˜æ˜¯å¤ªå¤§ï¼Œå†ç”¨"ã€‚"åˆ†å‰²ï¼ˆå¥å­ï¼‰
4. ...
```

**æ ¸å¿ƒé€»è¾‘**ï¼š
```python
def _split_text(self, text, separators):
    # ä»é«˜ä¼˜å…ˆçº§å¼€å§‹å°è¯•
    for separator in separators:
        if è¯¥åˆ†éš”ç¬¦å­˜åœ¨äºæ–‡æœ¬:
            ç”¨è¯¥åˆ†éš”ç¬¦åˆ‡åˆ†
            if åˆ‡åˆ†åçš„å—è¿˜æ˜¯å¤ªå¤§:
                é€’å½’è°ƒç”¨ï¼Œç”¨æ›´ä½ä¼˜å…ˆçº§çš„åˆ†éš”ç¬¦
            break
    
    return åˆå¹¶åçš„æ–‡æœ¬å—
```

**ä¼˜åŠ¿**ï¼š
- âœ… å°½é‡ä¿æŒæ®µè½å®Œæ•´æ€§
- âœ… é¿å…åœ¨å¥å­ä¸­é—´åˆ‡æ–­
- âœ… è¯­ä¹‰è¿è´¯æ€§æ›´å¥½

---

## ç¬¬å››éƒ¨åˆ†ï¼šChunk Size è°ƒä¼˜ â­â­â­

### ğŸ“Š é…ç½®å‚æ•°è¯´æ˜

**é…ç½®ä½ç½®**: `config.ini`

```ini
[retrieval]
parent_chunk_size = 1200  # çˆ¶æ–‡æ¡£å¤§å°ï¼ˆå­—ç¬¦ï¼‰
child_chunk_size = 300    # å­æ–‡æ¡£å¤§å°ï¼ˆå­—ç¬¦ï¼‰
chunk_overlap = 50        # é‡å å¤§å°ï¼ˆå­—ç¬¦ï¼‰
```

### ğŸ¯ å‚æ•°é€‰æ‹©æŒ‡å—

#### 1. Parent Chunk Sizeï¼ˆçˆ¶æ–‡æ¡£å¤§å°ï¼‰

| å¤§å° | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| 800-1000 | ä¸Šä¸‹æ–‡ç´§å‡‘ | å¯èƒ½ä¿¡æ¯ä¸å®Œæ•´ | ç®€çŸ­æ–‡æ¡£ |
| **1200** (æ¨è) | å¹³è¡¡ | - | **å¤§å¤šæ•°åœºæ™¯** |
| 1500-2000 | ä¸Šä¸‹æ–‡ä¸°å¯Œ | ä¿¡æ¯å¯†åº¦ä½ï¼ŒLLMå®¹æ˜“"èµ°ç¥" | å¤æ‚é—®é¢˜ |

**é€‰æ‹©å»ºè®®**ï¼š
- æ–‡æ¡£ç®€çŸ­ï¼ˆå¦‚FAQï¼‰ï¼š1000å­—
- ä¸€èˆ¬æ–‡æ¡£ï¼š**1200å­—**ï¼ˆé»˜è®¤ï¼‰
- æŠ€æœ¯æ–‡æ¡£ï¼š1500å­—

#### 2. Child Chunk Sizeï¼ˆå­æ–‡æ¡£å¤§å°ï¼‰

| å¤§å° | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| 200-250 | æ£€ç´¢æç²¾ç¡® | å¯èƒ½åˆ‡æ–­è¯­ä¹‰ | çŸ­é—®ç­” |
| **300** (æ¨è) | å¹³è¡¡ | - | **å¤§å¤šæ•°åœºæ™¯** |
| 400-500 | è¯­ä¹‰å®Œæ•´ | æ£€ç´¢ç²¾åº¦ç•¥é™ | é•¿æ®µè½æ–‡æ¡£ |

**é€‰æ‹©å»ºè®®**ï¼š
- çŸ­é—®ç­”ï¼ˆå¦‚å®¢æœï¼‰ï¼š250å­—
- ä¸€èˆ¬æ–‡æ¡£ï¼š**300å­—**ï¼ˆé»˜è®¤ï¼‰
- å­¦æœ¯æ–‡æ¡£ï¼š400å­—

#### 3. Chunk Overlapï¼ˆé‡å å¤§å°ï¼‰

```
[æ–‡æ¡£å—1: 0-300å­—]     [æ–‡æ¡£å—2: 250-550å­—]
                 â†‘
            é‡å 50å­—

ä½œç”¨ï¼šé¿å…åˆ‡æ–­è¯­ä¹‰è¿è´¯çš„å†…å®¹
```

| å¤§å° | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨è |
|------|------|------|------|
| 0 | å­˜å‚¨ç©ºé—´å° | å®¹æ˜“åˆ‡æ–­è¯­ä¹‰ | âŒ |
| **50** | ä¿è¯è¯­ä¹‰è¿è´¯ | - | âœ… |
| 100+ | å†—ä½™åº¦é«˜ | æµªè´¹å­˜å‚¨å’Œè®¡ç®— | âŒ |

**å…¬å¼å»ºè®®**ï¼š
```
overlap = chunk_size * 0.1 ~ 0.2

ä¾‹å¦‚ï¼šchild_chunk_size = 300
â†’ overlap = 30 ~ 60
â†’ æ¨è 50
```

---

## ç¬¬äº”éƒ¨åˆ†ï¼šå®æˆ˜ç¤ºä¾‹

### åœºæ™¯ï¼šå¤„ç†ä¸€ç¯‡æ•™å­¦æ–‡æ¡£

```python
åŸå§‹æ–‡æ¡£ï¼š"AIè¯¾ç¨‹å®Œæ•´ä»‹ç».pdf" (5000å­—)

é…ç½®ï¼š
parent_chunk_size = 1200
child_chunk_size = 300
chunk_overlap = 50
```

#### åˆ‡åˆ†ç»“æœ

```
åŸå§‹æ–‡æ¡£ (5000å­—)
         â†“
çˆ¶æ–‡æ¡£åˆ‡åˆ†ï¼ˆ1200å­—/å—ï¼Œé‡å 50å­—ï¼‰
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çˆ¶æ–‡æ¡£1 (1200å­—)   â”‚  å­—ç¬¦èŒƒå›´: 0-1200
â”‚ â”œâ”€ å­1 (300å­—)     â”‚  0-300
â”‚ â”œâ”€ å­2 (300å­—)     â”‚  250-550
â”‚ â”œâ”€ å­3 (300å­—)     â”‚  500-800
â”‚ â””â”€ å­4 (300å­—)     â”‚  750-1050
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çˆ¶æ–‡æ¡£2 (1200å­—)   â”‚  å­—ç¬¦èŒƒå›´: 1150-2350
â”‚ â”œâ”€ å­5 (300å­—)     â”‚  1150-1450
â”‚ â”œâ”€ å­6 (300å­—)     â”‚  1400-1700
â”‚ ...                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
...

æ€»è®¡ï¼š
- åŸå§‹æ–‡æ¡£: 1ä¸ª (5000å­—)
- çˆ¶æ–‡æ¡£: 5ä¸ª (æ¯ä¸ª1200å­—å·¦å³)
- å­æ–‡æ¡£: 20ä¸ª (æ¯ä¸ª300å­—å·¦å³)
```

#### å­˜å‚¨ç»“æ„ï¼ˆMilvusï¼‰

```python
# å­æ–‡æ¡£1çš„æ•°æ®
{
    "id": "doc_0_parent_0_child_0",
    "text": "AIè¯¾ç¨‹ä»‹ç»...(300å­—)",  # å­æ–‡æ¡£å†…å®¹ï¼ˆç”¨äºæ£€ç´¢ï¼‰
    "dense_vector": [0.1, 0.2, ...],
    "sparse_vector": {...},
    "parent_id": "doc_0_parent_0",
    "parent_content": "AIè¯¾ç¨‹ä»‹ç»...(1200å­—)",  # çˆ¶æ–‡æ¡£å†…å®¹ï¼ˆç”¨äºç”Ÿæˆï¼‰
    "source": "ai",
    "timestamp": "2026-01-04T15:00:00"
}
```

#### æ£€ç´¢æµç¨‹æ¼”ç¤º

```python
# ç”¨æˆ·æŸ¥è¯¢
query = "AIè¯¾ç¨‹çš„å­¦è´¹æ˜¯å¤šå°‘ï¼Ÿ"

# 1. å‘é‡åŒ–æŸ¥è¯¢å¹¶æ£€ç´¢å­æ–‡æ¡£
sub_chunks = vector_store.hybrid_search_with_rerank(query, k=3)
â†’ è¿”å›æœ€ç›¸å…³çš„3ä¸ªå­æ–‡æ¡£

# 2. æå–å»é‡çš„çˆ¶æ–‡æ¡£
parent_docs = _get_unique_parent_docs(sub_chunks)
â†’ ä»å­æ–‡æ¡£ä¸­æå– parent_content

# 3. æ„å»ºä¸Šä¸‹æ–‡
context = "\n\n".join([doc.page_content for doc in parent_docs])

# 4. LLMç”Ÿæˆç­”æ¡ˆ
answer = llm(f"ä¸Šä¸‹æ–‡: {context}\né—®é¢˜: {query}")
```

---

## ğŸ“ è°ƒä¼˜å®æˆ˜å»ºè®®

### ğŸ§ª å®éªŒ 1ï¼šè§‚å¯Ÿåˆ‡åˆ†æ•ˆæœ

```python
# åœ¨ document_processor.py ä¸­æ·»åŠ è°ƒè¯•ä»£ç 
for i, doc in enumerate(documents):
    parent_docs = parent_splitter.split_documents([doc])
    print(f"åŸå§‹æ–‡æ¡£{i}: {len(doc.page_content)}å­—")
    print(f"åˆ‡åˆ†æˆ {len(parent_docs)} ä¸ªçˆ¶æ–‡æ¡£")
    
    for j, parent_doc in enumerate(parent_docs):
        sub_chunks = child_splitter.split_documents([parent_doc])
        print(f"  çˆ¶æ–‡æ¡£{j}: {len(parent_doc.page_content)}å­— â†’ {len(sub_chunks)}ä¸ªå­æ–‡æ¡£")
```

### ğŸ§ª å®éªŒ 2ï¼šå¯¹æ¯”ä¸åŒå‚æ•°

| é…ç½® | parent | child | overlap | æ£€ç´¢æ•ˆæœ | ç”Ÿæˆè´¨é‡ |
|------|--------|-------|---------|---------|---------|
| é…ç½®A | 1000 | 250 | 30 | ç²¾ç¡®ä½†å¯èƒ½ä¸å®Œæ•´ | ä¸­ç­‰ |
| **é…ç½®B** | **1200** | **300** | **50** | **å¹³è¡¡** | **å¥½** |
| é…ç½®C | 1500 | 400 | 80 | è¦†ç›–é¢å¹¿ä½†ä¸ç²¾ç¡® | ä¿¡æ¯ä¸°å¯Œ |

**æµ‹è¯•æ–¹æ³•**ï¼š
1. ç”¨åŒæ ·çš„é—®é¢˜æµ‹è¯•
2. è§‚å¯Ÿæ£€ç´¢åˆ°çš„æ–‡æ¡£æ•°é‡å’Œç›¸å…³æ€§
3. è¯„ä¼°æœ€ç»ˆç­”æ¡ˆçš„è´¨é‡

### ğŸ§ª å®éªŒ 3ï¼šç‰¹æ®Šæ–‡æ¡£ç±»å‹

**Markdown æ–‡æ¡£**ï¼š
```python
# ä»£ç ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶ä½¿ç”¨ä¸“ç”¨åˆ†å‰²å™¨
if file_extension == '.md':
    ä½¿ç”¨ MarkdownTextSplitter  # ä¿ç•™Markdownç»“æ„
else:
    ä½¿ç”¨ ChineseRecursiveTextSplitter
```

**PDF å¸¦å›¾ç‰‡**ï¼š
- OCR æå–çš„æ–‡æœ¬å¯èƒ½ä¸è¿è´¯
- å»ºè®® chunk_overlap å¢å¤§åˆ° 80-100
- parent_chunk_size å‡å°åˆ° 1000

---

## âœ… æ ¸å¿ƒæ¦‚å¿µæ£€æŸ¥æ¸…å•

- [x] **æ–‡æ¡£åˆ†å‰²çš„å¿…è¦æ€§**ï¼šæé«˜æ£€ç´¢ç²¾åº¦å’Œç”Ÿæˆè´¨é‡
- [x] **çˆ¶å­æ–‡æ¡£è®¾è®¡**ï¼šå­æ–‡æ¡£æ£€ç´¢ï¼Œçˆ¶æ–‡æ¡£ç”Ÿæˆ
- [x] **åˆ†å±‚IDç®¡ç†**ï¼šdoc_i_parent_j_child_k
- [x] **é€’å½’åˆ†å‰²å™¨**ï¼šæŒ‰ä¼˜å…ˆçº§ä¿æŒè¯­ä¹‰å®Œæ•´æ€§
- [x] **å‚æ•°è°ƒä¼˜**ï¼šæ ¹æ®æ–‡æ¡£ç±»å‹é€‰æ‹©åˆé€‚çš„chunk size
- [x] **é‡å æœºåˆ¶**ï¼šé¿å…åˆ‡æ–­è¯­ä¹‰è¿è´¯çš„å†…å®¹

---

## ğŸ“Š å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨å°æ–‡æ¡£ï¼ˆ300å­—ï¼‰ï¼Ÿ

**å›ç­”**ï¼š
- æ£€ç´¢ç²¾ç¡®ï¼Œä½†ä¸Šä¸‹æ–‡ä¸å®Œæ•´
- LLM ç”Ÿæˆç­”æ¡ˆæ—¶ç¼ºå°‘å¿…è¦çš„èƒŒæ™¯ä¿¡æ¯

**ä¾‹å­**ï¼š
```
å­æ–‡æ¡£ï¼š"å­¦è´¹ä¸º19800å…ƒã€‚"
çˆ¶æ–‡æ¡£ï¼š"AIè¯¾ç¨‹ä»‹ç»...å­¦è´¹ä¸º19800å…ƒï¼ŒåŒ…å«çº¿ä¸Šè¯¾ç¨‹å’Œå®æˆ˜é¡¹ç›®ï¼Œå­¦ä¹ å‘¨æœŸ6ä¸ªæœˆ..."

ç”¨å­æ–‡æ¡£ç”Ÿæˆï¼š"å­¦è´¹ä¸º19800å…ƒã€‚"ï¼ˆä¿¡æ¯ä¸å…¨ï¼‰
ç”¨çˆ¶æ–‡æ¡£ç”Ÿæˆï¼š"å­¦è´¹ä¸º19800å…ƒï¼ŒåŒ…å«çº¿ä¸Šè¯¾ç¨‹å’Œå®æˆ˜é¡¹ç›®ã€‚"ï¼ˆå®Œæ•´ï¼‰
```

### Q2: Overlap è®¾ç½®å¤šå¤§åˆé€‚ï¼Ÿ

**ç»éªŒå…¬å¼**ï¼š
```
overlap = chunk_size * 0.1 ~ 0.2

child_chunk_size = 300 â†’ overlap = 30 ~ 60 ï¼ˆæ¨è50ï¼‰
parent_chunk_size = 1200 â†’ overlap = 120 ~ 240 ï¼ˆä½†é€šå¸¸ç»§æ‰¿childçš„overlapï¼‰
```

### Q3: å¦‚ä½•åˆ¤æ–­åˆ‡åˆ†æ•ˆæœå¥½ä¸å¥½ï¼Ÿ

**è¯„ä¼°æŒ‡æ ‡**ï¼š
1. **æ£€ç´¢å‡†ç¡®ç‡**ï¼šæ£€ç´¢åˆ°çš„æ–‡æ¡£æ˜¯å¦ç›¸å…³
2. **ç­”æ¡ˆå®Œæ•´æ€§**ï¼šç”Ÿæˆçš„ç­”æ¡ˆæ˜¯å¦åŒ…å«å¿…è¦ä¿¡æ¯
3. **è¯­ä¹‰è¿è´¯æ€§**ï¼šåˆ‡åˆ†ç‚¹æ˜¯å¦åœ¨å¥å­/æ®µè½è¾¹ç•Œ

**æµ‹è¯•æ–¹æ³•**ï¼š
```python
# æ‰‹åŠ¨æ£€æŸ¥å‡ ä¸ªåˆ‡åˆ†ç»“æœ
chunks = process_documents(directory_path)
for chunk in chunks[:5]:
    print("="*50)
    print(f"å­æ–‡æ¡£ID: {chunk.metadata['id']}")
    print(f"å­æ–‡æ¡£å†…å®¹: {chunk.page_content[:100]}...")
    print(f"çˆ¶æ–‡æ¡£å†…å®¹: {chunk.metadata['parent_content'][:200]}...")
```

---

## ğŸ“š æ‰©å±•é˜…è¯»

1. **LangChain Text Splitters**: [å®˜æ–¹æ–‡æ¡£](https://python.langchain.com/docs/modules/data_connection/document_transformers/)
2. **Chunking Strategies**: æœç´¢ "RAG chunking best practices"
3. **Parent-Child Retrieval**: "Parent Document Retriever" æŠ€æœ¯

---

**ä¸Šä¸€ä¸ªçŸ¥è¯†ç‚¹**: [03_æ£€ç´¢ç­–ç•¥é€‰æ‹©å™¨.md](./03_æ£€ç´¢ç­–ç•¥é€‰æ‹©å™¨.md)  
**ä¸‹ä¸€ä¸ªçŸ¥è¯†ç‚¹**: [05_Promptå·¥ç¨‹.md](./05_Promptå·¥ç¨‹.md)
