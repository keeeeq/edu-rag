# çŸ¥è¯†ç‚¹ 11: é…ç½®ç®¡ç†ç³»ç»Ÿ

> ğŸ“ **æ ¸å¿ƒæ–‡ä»¶**: `base/config.py` + `config.ini`  
> â±ï¸ **å­¦ä¹ æ—¶é—´**: çº¦ 20-30 åˆ†é’Ÿ  
> ğŸ¯ **é‡è¦æ€§**: â­â­â­ (ç³»ç»Ÿé…ç½®çš„ä¸­å¿ƒ)

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ:ä¸ºä»€ä¹ˆéœ€è¦é…ç½®ç®¡ç†?

### é—®é¢˜åœºæ™¯

**ç¡¬ç¼–ç é…ç½®:**
```python
# âŒ ä¸å¥½çš„åšæ³•
mysql_host = "localhost"
mysql_user = "root"
llm_model = "qwen-plus"
retrieval_k = 3
```

**é—®é¢˜:**
- âŒ ä¿®æ”¹é…ç½®éœ€è¦æ”¹ä»£ç 
- âŒ ä¸åŒç¯å¢ƒ(å¼€å‘/ç”Ÿäº§)éš¾ä»¥åˆ‡æ¢
- âŒ æ•æ„Ÿä¿¡æ¯(å¯†ç )æš´éœ²åœ¨ä»£ç ä¸­

**é…ç½®æ–‡ä»¶æ–¹æ¡ˆ:**
```ini
# âœ… å¥½çš„åšæ³•
[mysql]
host = localhost
user = root
password = your_password

[llm]
model = qwen-plus

[retrieval]
k = 3
```

**ä¼˜åŠ¿:**
- âœ… ä¿®æ”¹é…ç½®æ— éœ€æ”¹ä»£ç 
- âœ… ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒé…ç½®æ–‡ä»¶
- âœ… æ•æ„Ÿä¿¡æ¯ç‹¬ç«‹ç®¡ç†

---

## ç¬¬ä¸€éƒ¨åˆ†:config.iniç»“æ„

### ğŸ“„ é…ç½®æ–‡ä»¶è®¾è®¡

**ä»£ç ä½ç½®**: `config.ini`

```ini
# MySQLæ•°æ®åº“é…ç½®
[mysql]
host = localhost
user = root
password = your_password
database = subjects_kg

# Redisç¼“å­˜é…ç½®
[redis]
host = localhost
port = 6379
password = 
db = 0

# Milvuså‘é‡æ•°æ®åº“é…ç½®
[milvus]
host = localhost
port = 19530
collection_name = edurag_final

# LLMé…ç½®
[llm]
model = qwen-plus-2025-12-01
dashscope_api_key = sk-xxxxx
dashscope_base_url = https://dashscope.aliyuncs.com/compatible-mode/v1

# æ£€ç´¢å‚æ•°é…ç½®
[retrieval]
k = 3                    # åˆæ­¥æ£€ç´¢æ–‡æ¡£æ•°
m = 2                    # æœ€ç»ˆè¿”å›æ–‡æ¡£æ•°
parent_chunk_size = 1200 # çˆ¶æ–‡æ¡£å¤§å°
child_chunk_size = 300   # å­æ–‡æ¡£å¤§å°

# åº”ç”¨é…ç½®
[app]
customer_service_phone = 12345678
valid_sources = ai,java,test
log_dir = logs
```

---

## ç¬¬äºŒéƒ¨åˆ†:Configç±»è®¾è®¡

### ğŸ—ï¸ é…ç½®åŠ è½½å™¨

**ä»£ç ä½ç½®**: `base/config.py`

```python
import configparser
import os

class Config:
    def __init__(self, config_file='config.ini'):
        # è¯»å–é…ç½®æ–‡ä»¶
        self.config = configparser.ConfigParser()
        
        # è·å–é…ç½®æ–‡ä»¶è·¯å¾„
        current_dir = os.path.dirname(os.path.abspath(__file__))
        project_root = os.path.dirname(current_dir)
        config_path = os.path.join(project_root, config_file)
        
        # åŠ è½½é…ç½®
        self.config.read(config_path, encoding='utf-8')
        
        # è§£ææ‰€æœ‰é…ç½®
        self._load_mysql_config()
        self._load_redis_config()
        self._load_milvus_config()
        self._load_llm_config()
        self._load_retrieval_config()
        self._load_app_config()
```

### ğŸ“Š é…ç½®è§£æ

#### 1. MySQLé…ç½®

```python
def _load_mysql_config(self):
    """åŠ è½½MySQLé…ç½®"""
    self.MYSQL_HOST = self.config.get('mysql', 'host')
    self.MYSQL_USER = self.config.get('mysql', 'user')
    self.MYSQL_PASSWORD = self.config.get('mysql', 'password')
    self.MYSQL_DATABASE = self.config.get('mysql', 'database')
```

#### 2. Redisé…ç½®

```python
def _load_redis_config(self):
    """åŠ è½½Redisé…ç½®"""
    self.REDIS_HOST = self.config.get('redis', 'host')
    self.REDIS_PORT = self.config.getint('redis', 'port')
    self.REDIS_PASSWORD = self.config.get('redis', 'password')
    self.REDIS_DB = self.config.getint('redis', 'db')
```

#### 3. Milvusé…ç½®

```python
def _load_milvus_config(self):
    """åŠ è½½Milvusé…ç½®"""
    self.MILVUS_HOST = self.config.get('milvus', 'host')
    self.MILVUS_PORT = self.config.getint('milvus', 'port')
    self.COLLECTION_NAME = self.config.get('milvus', 'collection_name')
```

#### 4. LLMé…ç½®

```python
def _load_llm_config(self):
    """åŠ è½½LLMé…ç½®"""
    self.LLM_MODEL = self.config.get('llm', 'model')
    self.DASHSCOPE_API_KEY = self.config.get('llm', 'dashscope_api_key')
    self.DASHSCOPE_BASE_URL = self.config.get('llm', 'dashscope_base_url')
```

#### 5. æ£€ç´¢å‚æ•°é…ç½®

```python
def _load_retrieval_config(self):
    """åŠ è½½æ£€ç´¢å‚æ•°é…ç½®"""
    self.RETRIEVAL_K = self.config.getint('retrieval', 'k')
    self.CANDIDATE_M = self.config.getint('retrieval', 'm')
    self.PARENT_CHUNK_SIZE = self.config.getint('retrieval', 'parent_chunk_size')
    self.CHILD_CHUNK_SIZE = self.config.getint('retrieval', 'child_chunk_size')
```

#### 6. åº”ç”¨é…ç½®

```python
def _load_app_config(self):
    """åŠ è½½åº”ç”¨é…ç½®"""
    self.CUSTOMER_SERVICE_PHONE = self.config.get('app', 'customer_service_phone')
    
    # è§£æå­¦ç§‘åˆ—è¡¨
    sources_str = self.config.get('app', 'valid_sources')
    self.VALID_SOURCES = [s.strip() for s in sources_str.split(',')]
    
    self.LOG_DIR = self.config.get('app', 'log_dir')
```

---

## ç¬¬ä¸‰éƒ¨åˆ†:é…ç½®ä½¿ç”¨

### ğŸ’» åœ¨ä»£ç ä¸­ä½¿ç”¨é…ç½®

#### 1. MySQLè¿æ¥

```python
from base import Config

class MySQLClient:
    def __init__(self):
        config = Config()
        self.connect = pymysql.connect(
            host=config.MYSQL_HOST,
            user=config.MYSQL_USER,
            password=config.MYSQL_PASSWORD,
            database=config.MYSQL_DATABASE,
            charset='utf8mb4'
        )
```

#### 2. Milvusè¿æ¥

```python
class VectorStore:
    def __init__(self):
        config = Config()
        self.client = MilvusClient(
            uri=f"http://{config.MILVUS_HOST}:{config.MILVUS_PORT}"
        )
        self.collection_name = config.COLLECTION_NAME
```

#### 3. LLMè°ƒç”¨

```python
class IntegratedQASystem:
    def __init__(self):
        config = Config()
        self.client = OpenAI(
            api_key=config.DASHSCOPE_API_KEY,
            base_url=config.DASHSCOPE_BASE_URL
        )
        self.model = config.LLM_MODEL
```

#### 4. æ£€ç´¢å‚æ•°

```python
def retrieve_and_merge(self, query):
    config = Config()
    
    # ä½¿ç”¨é…ç½®çš„å‚æ•°
    ranked_chunks = self.vector_store.hybrid_search_with_rerank(
        query, 
        k=config.RETRIEVAL_K  # ä»é…ç½®è¯»å–
    )
    
    # å–Top-M
    final_docs = ranked_chunks[:config.CANDIDATE_M]
    return final_docs
```

---

## ç¬¬å››éƒ¨åˆ†:é…ç½®æœ€ä½³å®è·µ

### ğŸ”’ æ•æ„Ÿä¿¡æ¯ç®¡ç†

#### æ–¹æ³•1: ç¯å¢ƒå˜é‡(æ¨è)

```python
import os

class Config:
    def _load_llm_config(self):
        # ä¼˜å…ˆä»ç¯å¢ƒå˜é‡è¯»å–
        self.DASHSCOPE_API_KEY = os.getenv(
            'DASHSCOPE_API_KEY',
            self.config.get('llm', 'dashscope_api_key')
        )
```

**ä½¿ç”¨:**
```bash
# Linux/Mac
export DASHSCOPE_API_KEY=sk-xxxxx
python app.py

# Windows
set DASHSCOPE_API_KEY=sk-xxxxx
python app.py
```

#### æ–¹æ³•2: .envæ–‡ä»¶

```python
from dotenv import load_dotenv

load_dotenv()  # åŠ è½½.envæ–‡ä»¶

class Config:
    def __init__(self):
        self.DASHSCOPE_API_KEY = os.getenv('DASHSCOPE_API_KEY')
```

**.envæ–‡ä»¶:**
```
DASHSCOPE_API_KEY=sk-xxxxx
MYSQL_PASSWORD=your_password
```

**æ³¨æ„:** å°†`.env`æ·»åŠ åˆ°`.gitignore`,ä¸è¦æäº¤åˆ°Git

---

## ç¬¬äº”éƒ¨åˆ†:å¤šç¯å¢ƒé…ç½®

### ğŸŒ å¼€å‘/ç”Ÿäº§ç¯å¢ƒåˆ‡æ¢

#### æ–¹æ³•1: å¤šé…ç½®æ–‡ä»¶

```
config/
â”œâ”€â”€ config.dev.ini    # å¼€å‘ç¯å¢ƒ
â”œâ”€â”€ config.prod.ini   # ç”Ÿäº§ç¯å¢ƒ
â””â”€â”€ config.test.ini   # æµ‹è¯•ç¯å¢ƒ
```

**ä½¿ç”¨:**
```python
import os

class Config:
    def __init__(self):
        env = os.getenv('ENV', 'dev')
        config_file = f'config/config.{env}.ini'
        self.config.read(config_file)
```

```bash
# å¼€å‘ç¯å¢ƒ
ENV=dev python app.py

# ç”Ÿäº§ç¯å¢ƒ
ENV=prod python app.py
```

#### æ–¹æ³•2: é…ç½®è¦†ç›–

```python
class Config:
    def __init__(self):
        # 1. åŠ è½½é»˜è®¤é…ç½®
        self.config.read('config.ini')
        
        # 2. åŠ è½½ç¯å¢ƒç‰¹å®šé…ç½®(å¦‚æœå­˜åœ¨)
        env_config = f'config.{os.getenv("ENV", "dev")}.ini'
        if os.path.exists(env_config):
            self.config.read(env_config)  # è¦†ç›–é»˜è®¤é…ç½®
```

---

## ç¬¬å…­éƒ¨åˆ†:é…ç½®éªŒè¯

### âœ… å¯åŠ¨æ—¶éªŒè¯é…ç½®

```python
class Config:
    def __init__(self):
        self._load_all_configs()
        self._validate_configs()
    
    def _validate_configs(self):
        """éªŒè¯é…ç½®çš„æœ‰æ•ˆæ€§"""
        # éªŒè¯å¿…å¡«é¡¹
        assert self.MYSQL_HOST, "MySQL hostä¸èƒ½ä¸ºç©º"
        assert self.DASHSCOPE_API_KEY, "API keyä¸èƒ½ä¸ºç©º"
        
        # éªŒè¯æ•°å€¼èŒƒå›´
        assert 1 <= self.RETRIEVAL_K <= 10, "kå¿…é¡»åœ¨1-10ä¹‹é—´"
        assert self.CANDIDATE_M <= self.RETRIEVAL_K, "mä¸èƒ½å¤§äºk"
        
        # éªŒè¯æ–‡ä»¶è·¯å¾„
        if not os.path.exists(self.LOG_DIR):
            os.makedirs(self.LOG_DIR)
        
        print("âœ… é…ç½®éªŒè¯é€šè¿‡")
```

---

## ç¬¬ä¸ƒéƒ¨åˆ†:é…ç½®çƒ­æ›´æ–°(é«˜çº§)

### ğŸ”„ è¿è¡Œæ—¶æ›´æ–°é…ç½®

```python
import threading
import time

class Config:
    def __init__(self):
        self._load_configs()
        self._start_watch()
    
    def _start_watch(self):
        """ç›‘æ§é…ç½®æ–‡ä»¶å˜åŒ–"""
        def watch():
            last_mtime = os.path.getmtime('config.ini')
            while True:
                time.sleep(5)  # æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
                current_mtime = os.path.getmtime('config.ini')
                if current_mtime != last_mtime:
                    print("ğŸ”„ æ£€æµ‹åˆ°é…ç½®å˜åŒ–,é‡æ–°åŠ è½½...")
                    self._load_configs()
                    last_mtime = current_mtime
        
        thread = threading.Thread(target=watch, daemon=True)
        thread.start()
```

---

## âœ… æ ¸å¿ƒæ¦‚å¿µæ£€æŸ¥æ¸…å•

- [x] **config.ini**: INIæ ¼å¼é…ç½®æ–‡ä»¶
- [x] **Configç±»**: é…ç½®åŠ è½½å’Œè§£æ
- [x] **7å¤§é…ç½®ç±»åˆ«**: MySQLã€Redisã€Milvusã€LLMã€æ£€ç´¢ã€åº”ç”¨ã€æ—¥å¿—
- [x] **æ•æ„Ÿä¿¡æ¯**: ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–.envæ–‡ä»¶
- [x] **å¤šç¯å¢ƒ**: å¼€å‘/æµ‹è¯•/ç”Ÿäº§é…ç½®åˆ†ç¦»
- [x] **é…ç½®éªŒè¯**: å¯åŠ¨æ—¶æ£€æŸ¥é…ç½®æœ‰æ•ˆæ€§

---

## ğŸ“Š é…ç½®ç®¡ç†å¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **ç¡¬ç¼–ç ** | ç®€å• | ä¸çµæ´»,ä¸å®‰å…¨ | å°demo |
| **config.ini** | æ˜“è¯»,æ˜“ä¿®æ”¹ | æ•æ„Ÿä¿¡æ¯æš´éœ² | ä¸­å°é¡¹ç›® |
| **ç¯å¢ƒå˜é‡** | å®‰å…¨ | ç®¡ç†å¤æ‚ | ç”Ÿäº§ç¯å¢ƒ |
| **.envæ–‡ä»¶** | å®‰å…¨+æ˜“ç®¡ç† | éœ€è¦é¢å¤–åº“ | æ¨èæ–¹æ¡ˆ |
| **é…ç½®ä¸­å¿ƒ** | é›†ä¸­ç®¡ç†,çƒ­æ›´æ–° | å¤æ‚,éœ€è¦é¢å¤–æœåŠ¡ | å¤§å‹é¡¹ç›® |

---

**ä¸Šä¸€ä¸ªçŸ¥è¯†ç‚¹**: [10_FastAPI WebæœåŠ¡.md](./10_FastAPI WebæœåŠ¡.md)  
**è¿”å›ç›®å½•**: [README.md](./README.md)

---

## ğŸ‰ æ­å–œ!

ä½ å·²ç»å®Œæˆäº†**æ‰€æœ‰11ä¸ªçŸ¥è¯†ç‚¹**çš„å­¦ä¹ !

ç°åœ¨ä½ å·²ç»æŒæ¡:
- âœ… RAGæ ¸å¿ƒæŠ€æœ¯(å‘é‡æ£€ç´¢ã€ç­–ç•¥é€‰æ‹©ã€æ–‡æ¡£åˆ†å‰²)
- âœ… ç³»ç»Ÿé›†æˆ(BM25ã€ä¼šè¯ç®¡ç†ã€WebæœåŠ¡)
- âœ… å·¥ç¨‹å®è·µ(é…ç½®ç®¡ç†ã€æ—¥å¿—ã€é”™è¯¯å¤„ç†)

**ä¸‹ä¸€æ­¥å»ºè®®:**
1. åŠ¨æ‰‹å®è·µ:éƒ¨ç½²è¿è¡Œå®Œæ•´ç³»ç»Ÿ
2. å‚æ•°è°ƒä¼˜:è°ƒæ•´æ£€ç´¢å‚æ•°è§‚å¯Ÿæ•ˆæœ
3. åŠŸèƒ½æ‰©å±•:æ·»åŠ æ–°çš„æ£€ç´¢ç­–ç•¥æˆ–æ•°æ®æº
