# çŸ¥è¯†ç‚¹ 1: å‘é‡æ£€ç´¢ä¸å­˜å‚¨

> ğŸ“ **æ ¸å¿ƒæ–‡ä»¶**: `rag_qa/core/vector_store.py`  
> â±ï¸ **å­¦ä¹ æ—¶é—´**: çº¦ 30-45 åˆ†é’Ÿ  
> ğŸ¯ **é‡è¦æ€§**: â­â­â­â­â­ (RAG çš„æ ¸å¿ƒå¼•æ“)

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ ğŸ†•

æœ¬é¡¹ç›®é‡‡ç”¨**åˆ†å±‚æ£€ç´¢æ¶æ„**:

```
ç”¨æˆ·æŸ¥è¯¢
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BM25æ£€ç´¢(MySQL) â”‚ â† ç¬¬ä¸€å±‚:ç²¾ç¡®åŒ¹é…(çŸ¥è¯†ç‚¹8)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (æ— ç»“æœ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RAGæ£€ç´¢(Milvus) â”‚ â† ç¬¬äºŒå±‚:è¯­ä¹‰æ£€ç´¢(æœ¬æ¨¡å—)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡?**
- BM25é€‚åˆç²¾ç¡®é—®ç­”(å¦‚"å­¦è´¹å¤šå°‘") - å¿«é€Ÿè¿”å›
- RAGé€‚åˆå¼€æ”¾æ€§é—®é¢˜(å¦‚"è¯¾ç¨‹æ€ä¹ˆæ ·") - è¯­ä¹‰ç†è§£
- åˆ†å±‚æ£€ç´¢å…¼é¡¾é€Ÿåº¦å’Œå‡†ç¡®åº¦

**æœ¬æ¨¡å—çš„è§’è‰²**: å½“BM25æ— æ³•æ‰¾åˆ°ç­”æ¡ˆæ—¶,ç³»ç»Ÿä¼šè°ƒç”¨æœ¬æ¨¡å—è¿›è¡Œå‘é‡æ£€ç´¢ã€‚

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šæ–‡æœ¬å‘é‡åŒ–ï¼ˆEmbeddingï¼‰çš„æœ¬è´¨

### ğŸ¤” æ ¸å¿ƒé—®é¢˜ï¼šè®¡ç®—æœºå¦‚ä½•ç†è§£æ–‡æœ¬ï¼Ÿ

```
ä¼ ç»Ÿæ–¹å¼ï¼š
"è‹¹æœ" â†’ åªæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè®¡ç®—æœºä¸ç†è§£å«ä¹‰

å‘é‡åŒ–æ–¹å¼ï¼š
"è‹¹æœ" â†’ [0.6, -0.2, 0.8, 0.1, ...] (1024ç»´å‘é‡)
"æ°´æœ" â†’ [0.5, -0.3, 0.7, 0.2, ...]
"æ‰‹æœº" â†’ [-0.1, 0.9, -0.4, 0.8, ...]
```

**å…³é”®å‘ç°**ï¼š
- "è‹¹æœ"å’Œ"æ°´æœ"çš„å‘é‡**å¾ˆæ¥è¿‘**ï¼ˆç›¸ä¼¼åº¦é«˜ï¼‰
- "è‹¹æœ"å’Œ"æ‰‹æœº"çš„å‘é‡**å¾ˆè¿œ**ï¼ˆç›¸ä¼¼åº¦ä½ï¼‰

### ğŸ’¡ å‘é‡åŒ–çš„é­”æ³•ï¼šè¯­ä¹‰ç›¸ä¼¼ = å‘é‡ç›¸è¿‘

**ä»£ç ä½ç½®**: ç¬¬ 61-66 è¡Œ

```python
# åŠ è½½ BGE-M3 åµŒå…¥æ¨¡å‹
self.embedding_function = BGEM3EmbeddingFunction(
    model_name_or_path=m3_path,  # æ¨¡å‹è·¯å¾„
    use_fp16=(self.device == 'cuda'),  # GPUç”¨åŠç²¾åº¦
    device=self.device
)

# è·å–å‘é‡ç»´åº¦
self.dense_dim = self.embedding_function.dim["dense"]  # 1024ç»´
```

**BGE-M3 ç‰¹ç‚¹**ï¼š
- **åŒå‘é‡è¾“å‡º**ï¼š
  - **ç¨ å¯†å‘é‡ï¼ˆDenseï¼‰**ï¼š1024 ç»´ï¼Œæ•æ‰è¯­ä¹‰
  - **ç¨€ç–å‘é‡ï¼ˆSparseï¼‰**ï¼šåƒ BM25ï¼Œæ•æ‰å…³é”®è¯

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šå‘é‡æ•°æ®åº“çš„æ ¸å¿ƒ - Milvus

### ğŸ“¦ Milvus çš„æ•°æ®ç»“æ„

**ä»£ç ä½ç½®**: ç¬¬ 73-124 è¡Œ

```python
# åˆ›å»ºé›†åˆçš„å­—æ®µå®šä¹‰
schema.add_field("id", VARCHAR, max_length=100)           # å”¯ä¸€ID
schema.add_field("text", VARCHAR, max_length=65535)       # å­æ–‡æ¡£å†…å®¹
schema.add_field("dense_vector", FLOAT_VECTOR, dim=1024)  # ç¨ å¯†å‘é‡
schema.add_field("sparse_vector", SPARSE_FLOAT_VECTOR)    # ç¨€ç–å‘é‡
schema.add_field("parent_id", VARCHAR)                    # çˆ¶æ–‡æ¡£ID
schema.add_field("parent_content", VARCHAR)               # çˆ¶æ–‡æ¡£å†…å®¹
schema.add_field("source", VARCHAR)                       # æ¥æº(ai/java/test)
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™äº›å­—æ®µï¼Ÿ**
- `text` + `dense_vector`ï¼šå­æ–‡æ¡£ + å‘é‡ï¼ˆç”¨äºæ£€ç´¢ï¼‰
- `parent_content`ï¼šçˆ¶æ–‡æ¡£ï¼ˆç”¨äºç”Ÿæˆç­”æ¡ˆï¼‰
- `source`ï¼šå­¦ç§‘è¿‡æ»¤

### ğŸ—‚ï¸ ç´¢å¼•ï¼šè®©æ£€ç´¢è¶…å¿«

**ä»£ç ä½ç½®**: ç¬¬ 96-112 è¡Œ

```python
# ç¨ å¯†å‘é‡ç´¢å¼• - IVF_FLAT
index_params.add_index(
    field_name="dense_vector",
    index_type="IVF_FLAT",      # å€’æ’æ–‡ä»¶ç´¢å¼•
    metric_type="IP",            # å†…ç§¯ï¼ˆInner Productï¼‰
    params={"nlist": 128}        # 128ä¸ªèšç±»ä¸­å¿ƒ
)

# ç¨€ç–å‘é‡ç´¢å¼• - å€’æ’ç´¢å¼•
index_params.add_index(
    field_name="sparse_vector",
    index_type="SPARSE_INVERTED_INDEX",  # ç±»ä¼¼æœç´¢å¼•æ“
    metric_type="IP"
)
```

**ç±»æ¯”ç†è§£**ï¼š
- **æ— ç´¢å¼•**ï¼šæŒ¨ä¸ªæ¯”å¯¹ï¼Œ100 ä¸‡æ–‡æ¡£è¦ç®— 100 ä¸‡æ¬¡
- **æœ‰ç´¢å¼•**ï¼šå…ˆèšç±»ï¼Œåªéœ€æ¯”å¯¹å‡ ç™¾ä¸ªèšç±»ä¸­å¿ƒ

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ··åˆæ£€ç´¢çš„å¨åŠ› â­â­â­

### ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦æ··åˆæ£€ç´¢ï¼Ÿ

| æŸ¥è¯¢ç±»å‹ | ä¾‹å­ | ç¨ å¯†å‘é‡ | ç¨€ç–å‘é‡ |
|---------|------|---------|---------|
| è¯­ä¹‰æŸ¥è¯¢ | "ç¼–ç¨‹è¯­è¨€çš„ä¼˜ç‚¹" | âœ… ä¼˜ç§€ | âŒ ä¸€èˆ¬ |
| å…³é”®è¯æŸ¥è¯¢ | "Python 3.11" | âŒ ä¸€èˆ¬ | âœ… ç²¾ç¡® |
| ä¸“æœ‰åè¯ | "Kubernetes" | âŒ å¯èƒ½ç†è§£é”™ | âœ… ç²¾ç¡®åŒ¹é… |

**ç»“è®º**ï¼šç»“åˆä¸¤è€… = å…¼é¡¾è¯­ä¹‰ + ç²¾ç¡®åº¦

### ğŸ” æ··åˆæ£€ç´¢ä»£ç è¯¦è§£

**ä»£ç ä½ç½®**: ç¬¬ 183-259 è¡Œ

#### æ­¥éª¤ 1ï¼šå‘é‡åŒ–æŸ¥è¯¢ï¼ˆç¬¬ 184-199 è¡Œï¼‰

```python
def hybrid_search_with_rerank(self, query, k=3, source_filter=None):
    # 1. å°†ç”¨æˆ·é—®é¢˜å‘é‡åŒ–
    query_embeddings = self.embedding_function([query])
    
    # 2. æå–ç¨ å¯†å‘é‡ï¼ˆè¯­ä¹‰ï¼‰
    dense_query_vector = query_embeddings["dense"][0]  # [1024]
    
    # 3. æå–ç¨€ç–å‘é‡ï¼ˆå…³é”®è¯ï¼‰
    sparse_query_vector = {}
    row = query_embeddings["sparse"].getrow(0)
    for idx, value in zip(row.indices, row.data):
        sparse_query_vector[idx] = value
```

**ä¾‹å­**ï¼š
```python
æŸ¥è¯¢ï¼š"AIè¯¾ç¨‹çš„å­¦è´¹"
â†’ dense_vector: [0.3, -0.5, 0.8, ...]  # æ•æ‰"è¯¾ç¨‹è´¹ç”¨"çš„è¯­ä¹‰
â†’ sparse_vector: {215: 0.9, 487: 0.7} # å…³é”®è¯"AI""å­¦è´¹"çš„æƒé‡
```

#### æ­¥éª¤ 2ï¼šåˆ›å»ºåŒé‡æ£€ç´¢è¯·æ±‚ï¼ˆç¬¬ 204-219 è¡Œï¼‰

```python
# ç¨ å¯†å‘é‡æ£€ç´¢è¯·æ±‚
dense_request = AnnSearchRequest(
    data=[dense_query_vector],
    anns_field="dense_vector",
    param={"metric_type": "IP", "params": {"nprobe": 10}},
    limit=k,  # è¿”å› Top-K
    expr=filter_expr  # è¿‡æ»¤æ¡ä»¶ï¼Œå¦‚ source=='ai'
)

# ç¨€ç–å‘é‡æ£€ç´¢è¯·æ±‚
sparse_request = AnnSearchRequest(
    data=[sparse_query_vector],
    anns_field="sparse_vector",
    param={"metric_type": "IP"},
    limit=k
)
```

**IPï¼ˆInner Productï¼Œå†…ç§¯ï¼‰**ï¼š
```
å‘é‡A = [1, 2, 3]
å‘é‡B = [4, 5, 6]
å†…ç§¯ = 1Ã—4 + 2Ã—5 + 3Ã—6 = 32

å†…ç§¯è¶Šå¤§ = å‘é‡è¶Šç›¸ä¼¼
```

#### æ­¥éª¤ 3ï¼šåŠ æƒèåˆï¼ˆç¬¬ 221-230 è¡Œï¼‰â­

```python
# åˆ›å»ºåŠ æƒæ’åºå™¨
ranker = WeightedRanker(1.0, 0.7)  # ç¨ å¯†æƒé‡1.0ï¼Œç¨€ç–æƒé‡0.7

# æ‰§è¡Œæ··åˆæœç´¢
results = self.client.hybrid_search(
    collection_name=self.collection_name,
    reqs=[dense_request, sparse_request],  # ä¸¤ä¸ªæ£€ç´¢è¯·æ±‚
    ranker=ranker,  # åŠ æƒèåˆ
    limit=k
)[0]
```

**èåˆç®—æ³•**ï¼š
```
æœ€ç»ˆåˆ†æ•° = 1.0 Ã— ç¨ å¯†åˆ†æ•° + 0.7 Ã— ç¨€ç–åˆ†æ•°

ç¤ºä¾‹ï¼š
æ–‡æ¡£A: ç¨ å¯†åˆ†æ•°=0.8, ç¨€ç–åˆ†æ•°=0.3 â†’ æœ€ç»ˆ=1.0Ã—0.8 + 0.7Ã—0.3 = 1.01
æ–‡æ¡£B: ç¨ å¯†åˆ†æ•°=0.6, ç¨€ç–åˆ†æ•°=0.9 â†’ æœ€ç»ˆ=1.0Ã—0.6 + 0.7Ã—0.9 = 1.23
â†’ æ–‡æ¡£B æ’åæ›´é«˜ï¼ˆå…³é”®è¯åŒ¹é…å¥½ï¼‰
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šé‡æ’åºï¼ˆRerankï¼‰- æœ€åçš„ç²¾ç‚¼ â­â­â­

### ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦ Rerankï¼Ÿ

**é—®é¢˜**ï¼šæ··åˆæ£€ç´¢åªæ˜¯"ç²—ç­›"ï¼Œå¯èƒ½è¯¯åˆ¤ã€‚

**Rerank åŸç†**ï¼šç”¨æ›´å¼ºå¤§çš„æ¨¡å‹ï¼ˆCrossEncoderï¼‰é‡æ–°æ‰“åˆ†ã€‚

### ğŸ“Š ä»£ç å®ç°

**ä»£ç ä½ç½®**: ç¬¬ 245-259 è¡Œ

```python
if parent_docs:
    # 1. åˆ›å»º<æŸ¥è¯¢, æ–‡æ¡£>é…å¯¹
    pairs = [[query, doc.page_content] for doc in parent_docs]
    # æŸ¥è¯¢: "AIè¯¾ç¨‹çš„å­¦è´¹"
    # æ–‡æ¡£1: "AIå­¦ç§‘ä»‹ç»..."
    # æ–‡æ¡£2: "è¯¾ç¨‹è´¹ç”¨ä¸º..."
    # â†’ pairs = [["AIè¯¾ç¨‹çš„å­¦è´¹", "AIå­¦ç§‘ä»‹ç»..."], 
    #            ["AIè¯¾ç¨‹çš„å­¦è´¹", "è¯¾ç¨‹è´¹ç”¨ä¸º..."]]
    
    # 2. CrossEncoder é‡æ–°æ‰“åˆ†
    scores = self.reranker.predict(pairs)
    # â†’ scores = [0.65, 0.92]  # æ–‡æ¡£2æ›´ç›¸å…³
    
    # 3. æ ¹æ®åˆ†æ•°é‡æ–°æ’åº
    ranked_docs = [doc for _, doc in sorted(zip(scores, parent_docs), reverse=True)]
    # â†’ [æ–‡æ¡£2, æ–‡æ¡£1]
```

**CrossEncoder vs æ™®é€š Embedding**ï¼š
- **Embedding**ï¼šåˆ†åˆ«ç¼–ç æŸ¥è¯¢å’Œæ–‡æ¡£ï¼Œå†ç®—ç›¸ä¼¼åº¦ï¼ˆå¿«ä½†ç²—ç³™ï¼‰
- **CrossEncoder**ï¼šåŒæ—¶è€ƒè™‘æŸ¥è¯¢å’Œæ–‡æ¡£çš„äº¤äº’ï¼ˆæ…¢ä½†ç²¾ç¡®ï¼‰

---

## ğŸ¯ å®Œæ•´æµç¨‹æ€»ç»“

```
ç”¨æˆ·æŸ¥è¯¢: AIè¯¾ç¨‹çš„å­¦è´¹
    â†“
å‘é‡åŒ–
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¨ å¯†å‘é‡æ£€ç´¢    â”‚  ç¨€ç–å‘é‡æ£€ç´¢    â”‚
â”‚  (è¯­ä¹‰ç†è§£)     â”‚  (å…³é”®è¯åŒ¹é…)    â”‚
â”‚  Top-3         â”‚  Top-3          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
    åŠ æƒèåˆ WeightedRanker
    1.0 Ã— dense + 0.7 Ã— sparse
            â†“
    æ··åˆæ£€ç´¢ç»“æœ (Top-K å­æ–‡æ¡£)
            â†“
    æå–å»é‡çš„çˆ¶æ–‡æ¡£
            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ æ–‡æ¡£æ•° >= 2?     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       æ˜¯â†“        å¦â†“
    Rerank      ç›´æ¥è¿”å›
       â†“            â†“
    è¿”å› Top-M çˆ¶æ–‡æ¡£
```

---

## âœ… æ ¸å¿ƒæ¦‚å¿µæ£€æŸ¥æ¸…å•

- [x] **å‘é‡åŒ–**ï¼šæ–‡æœ¬ â†’ æ•°å­—å‘é‡ï¼Œè¯­ä¹‰ç›¸ä¼¼ = å‘é‡ç›¸è¿‘
- [x] **ç¨ å¯†å‘é‡**ï¼šæ•æ‰è¯­ä¹‰ï¼ˆ1024 ç»´ï¼‰
- [x] **ç¨€ç–å‘é‡**ï¼šæ•æ‰å…³é”®è¯ï¼ˆBM25 é£æ ¼ï¼‰
- [x] **æ··åˆæ£€ç´¢**ï¼šåŒå‘é‡ + åŠ æƒèåˆ
- [x] **Rerank**ï¼šCrossEncoder äºŒæ¬¡æ‰“åˆ†
- [x] **çˆ¶å­æ–‡æ¡£**ï¼šå­æ–‡æ¡£æ£€ç´¢ï¼ˆç²¾ç¡®ï¼‰ï¼Œçˆ¶æ–‡æ¡£ç”Ÿæˆï¼ˆå®Œæ•´ï¼‰

---

## ğŸ“š è¿›é˜¶å­¦ä¹ èµ„æº

1. **BGE-M3 è®ºæ–‡**: [BAAI/bge-m3](https://huggingface.co/BAAI/bge-m3)
2. **Milvus æ–‡æ¡£**: [https://milvus.io/docs](https://milvus.io/docs)
3. **å‘é‡æ£€ç´¢åŸç†**: æœç´¢ "HNSW ç®—æ³•" å’Œ "IVF-FLAT ç´¢å¼•"

---

## ğŸ”— ä¸ç³»ç»Ÿé›†æˆ ğŸ†•

å‘é‡æ£€ç´¢æ˜¯RAGç³»ç»Ÿçš„**ç¬¬äºŒå±‚æ£€ç´¢**:

### è°ƒç”¨æµç¨‹

```
new_main.py (IntegratedQASystem)
    â†“
1. bm25_search.search()        # ç¬¬ä¸€å±‚:BM25æ£€ç´¢
    â†“ (æ— ç»“æœ)
2. rag_system.generate_answer() # ç¬¬äºŒå±‚:RAGæ£€ç´¢
    â†“
3. vector_store.hybrid_search_with_rerank()  # æœ¬æ¨¡å—
```

### ä»£ç è°ƒç”¨é“¾

**ä»£ç ä½ç½®**: `new_main.py` ç¬¬213-222è¡Œ

```python
# BM25æ— ç»“æœ,å›é€€åˆ°RAG
elif need_rag:
    logger.info("æ— å¯é MySQLç­”æ¡ˆ,å›é€€åˆ°RAG")
    collected_answer = ""
    # è°ƒç”¨RAGç³»ç»Ÿ
    for token in self.rag_system.generate_answer(query, source_filter=source_filter, history=history):
        collected_answer += token
        yield token, False
```

**RAGç³»ç»Ÿå†…éƒ¨**: `rag_qa/core/rag_system.py`

```python
# RAGç³»ç»Ÿè°ƒç”¨å‘é‡æ£€ç´¢
context_docs = self.vector_store.hybrid_search_with_rerank(
    query, 
    k=conf.RETRIEVAL_K,  # æ£€ç´¢Top-K
    source_filter=source_filter
)
```

### ç³»ç»Ÿä¼˜åŠ¿

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **åˆ†å±‚æ£€ç´¢** | BM25å¿«é€Ÿè¿‡æ»¤ â†’ å‘é‡æ£€ç´¢ç²¾å‡†åŒ¹é… |
| **æˆæœ¬ä¼˜åŒ–** | ç®€å•é—®é¢˜ä¸è°ƒç”¨å‘é‡æ£€ç´¢,èŠ‚çœæ—¶é—´å’Œèµ„æº |
| **å‡†ç¡®åº¦é«˜** | å¤æ‚é—®é¢˜ä½¿ç”¨è¯­ä¹‰æ£€ç´¢,ç†è§£æ›´æ·±å…¥ |

---

**ä¸‹ä¸€ä¸ªçŸ¥è¯†ç‚¹**: [02_RAGæ ¸å¿ƒæµç¨‹.md](./02_RAGæ ¸å¿ƒæµç¨‹.md)

